<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
                if self.market_type == MARKET_TYPE.FUTURE_CN:
                    &#47&#47 å¦‚æœæœ‰è´ŸæŒä»“-- å…è®¸å–ç©ºçš„æ—¶å€™
                    if towards == 3: &#47&#47 å¤šå¹³
                        _hold = <a id="change">self.sell_available.get(code, 0)</a>
                                     &#47&#47 å‡è®¾æœ‰è´ŸæŒä»“:
                                     &#47&#47 amountä¸ºä¸‹å•æ•°é‡ å¦‚  è´¦æˆ·åŸå…ˆ-3æ‰‹ ç°åœ¨å¹³1æ‰‹

                        &#47&#47left_amount = amount+_hold if _hold &lt; 0 else amount</code></pre><h3>After Change</h3><pre><code class='java'>
        pass

    def send_order(
            <a id="change">self</a>,
            code=None,
            amount=None,
            time=None,
            towards=None,
            price=None,
            money=None,
            order_model=ORDER_MODEL.LIMIT,
            amount_model=AMOUNT_MODEL.BY_AMOUNT,
            order_id=None,
            position_id=None,
            *args,
            **kwargs
    ):

        wrong_reason = None
        assert code is not None and time is not None and towards is not None and order_model is not None and amount_model is not None
        date = str(time)[0:10] if len(str(time)) == 19 else str(time)
        time = str(time) if len(str(time)) == 19 else &quot{} 09:31:00&quot.format(
            str(time)[0:10]
        )
        if self.allow_margin:
            amount = amount if amount_model is AMOUNT_MODEL.BY_AMOUNT else int(
                money / (
                    self.market_preset.get_unit(code) *
                    self.market_preset.get_frozen(code) * price *
                    (1 + self.commission_coeff)
                ) / 100
            ) * 100
        else:
            amount = amount if amount_model is AMOUNT_MODEL.BY_AMOUNT else int(
                money / (price * (1 + self.commission_coeff)) / 100
            ) * 100

        &#47&#47 ğŸ› todo ç§»åˆ°Utilsç±»ä¸­ï¼Œ  money_to_amount é‡‘é¢è½¬æˆäº¤é‡
        if self.allow_margin:
            money = amount * price * self.market_preset.get_unit(code)*self.market_preset.get_frozen(code) * \
                (1+self.commission_coeff) if amount_model is AMOUNT_MODEL.BY_AMOUNT else money
        else:
            money = amount * price * \
                (1+self.commission_coeff) if amount_model is AMOUNT_MODEL.BY_AMOUNT else money

        &#47&#47 flag åˆ¤æ–­ä¹°å– æ•°é‡å’Œä»·æ ¼ä»¥åŠä¹°å–æ–¹å‘æ˜¯å¦æ­£ç¡®
        flag = False

        assert (int(towards) != 0)
        if int(towards) in [1, 2, 3]:
            &#47&#47 æ˜¯ä¹°å…¥çš„æƒ…å†µ(åŒ…æ‹¬ä¹°å…¥.ä¹°å¼€.ä¹°å¹³)
            if self.cash_available &gt;= money:
                if self.market_type == MARKET_TYPE.STOCK_CN:  &#47&#47 å¦‚æœæ˜¯è‚¡ç¥¨ ä¹°å…¥çš„æ—¶å€™æœ‰100è‚¡çš„æœ€å°é™åˆ¶
                    amount = int(amount / 100) * 100
                    self.cash_available -= money
                    flag = True

                if self.running_environment == RUNNING_ENVIRONMENT.TZERO:

                    if abs(self.buy_available.get(code, 0)) &gt;= amount:
                        flag = True
                        self.cash_available -= money
                        self.buy_available[code] -= amount
                    else:
                        flag = False
                        wrong_reason = &quotT0äº¤æ˜“ä¹°å…¥è¶…å‡ºé™é¢&quot

                if self.market_type == MARKET_TYPE.FUTURE_CN:
                    &#47&#47 å¦‚æœæœ‰è´ŸæŒä»“-- å…è®¸å–ç©ºçš„æ—¶å€™
                    if towards == 3:  &#47&#47 å¤šå¹³
                        pos = <a id="change">self.get_position(code)</a>
                        &#47&#47 å‡è®¾æœ‰è´ŸæŒä»“:
                        &#47&#47 amountä¸ºä¸‹å•æ•°é‡ å¦‚  è´¦æˆ·åŸå…ˆ-3æ‰‹ ç°åœ¨å¹³1æ‰‹

                        &#47&#47left_amount = amount+_hold if _hold &lt; 0 else amount
                        money_need = abs(
                            float(amount * price * (1 + self.commission_coeff))
                        )

                        if self.cash_available &gt;= money_need:
                            if pos.volume_short &gt; 0:
                                self.cash_available -= money_need

                                flag = True
                            else:
                                wrong_reason = &quotç©ºå•ä»“ä½ä¸è¶³&quot
                        else:
                            wrong_reason = &quotå¹³å¤šå‰©ä½™èµ„é‡‘ä¸å¤Ÿ&quot
                    if towards == 2:
                        self.cash_available -= money
                        flag = True
            else:
                wrong_reason = &quotQAACCOUNT: å¯ç”¨èµ„é‡‘ä¸è¶³ cash_available {}  code {} time {} amount {} towards {}&quot.format(
                    self.cash_available,
                    code,
                    time,
                    amount,
                    towards
                )
        elif int(towards) in [-1, -2, -3]:
            &#47&#47 æ˜¯å–å‡ºçš„æƒ…å†µ(åŒ…æ‹¬å–å‡ºï¼Œå–å‡ºå¼€ä»“allow_sellopenå¦‚æœå…è®¸. å–å‡ºå¹³ä»“)
            &#47&#47 print(self.sell_available[code])
            pos = self.get_position(code)  &#47&#47 _hold æ˜¯ä½ çš„æŒä»“

            &#47&#47 å¦‚æœä½ çš„hold&gt; amount&gt;0
            &#47&#47 æŒä»“æ•°é‡&gt;å–å‡ºæ•°é‡

            if towards == -1:
                if pos.volume_long_his &gt;= amount:
                    self.sell_available[code] -= amount
                    &#47&#47 towards = ORDER_DIRECTION.SELL
                    flag = True
            elif towards == -2:
                if self.allow_sellopen:
                    if self.cash_available &gt;= money:  &#47&#47 å–ç©ºçš„å¸‚å€¼å°äºç°é‡‘ï¼ˆæœ‰æ‹…ä¿çš„å–ç©ºï¼‰ï¼Œ ä¸å…è®¸è£¸å–ç©º
                                                    &#47&#47 self.cash_available -= money
                        flag = True
                    else:
                        print(&quotsellavailable&quot, _hold)
                        print(&quotamount&quot, amount)
                        print(&quotaqureMoney&quot, money)
                        print(&quotcash&quot, self.cash_available)
                        wrong_reason = "å–ç©ºèµ„é‡‘ä¸è¶³"
                else:
                    wrong_reason = "ä¸å…è®¸å–ç©º"

            else:
                if pos.volume_long &gt;= amount:
                    <a id="change">self.sell_available[code]</a> -= amount
                    &#47&#47 towards = ORDER_DIRECTION.SELL
                    flag = True
                &#47&#47 å¦‚æœæŒä»“æ•°é‡&lt;å–å‡ºæ•°é‡</code></pre>